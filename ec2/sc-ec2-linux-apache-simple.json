{
    "Description": "AWS EC2 Apache webserver (fdp-1p4dlgcpe)",
    "Parameters": {
        "KeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "WebServerSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup::Id"
        },
        "PublicSubnet": {
            "Type": "AWS::EC2::Subnet::Id"
        },
        "InstanceType": {
            "Type": "String",
            "Default":"t3.micro",
            "AllowedValues": ["t2.micro","t2.medium","t3.micro","t3.medium","t3.large"]
        },
        "LatestAmiId": {
            "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
            "Default": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
        }
    },
    
    "Resources": {
        "WebServerInstance": {
      "Type": "AWS::EC2::Instance",
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "All": [
              "ConfigureSampleApp"
            ]
          },
          "ConfigureSampleApp": {
            "packages": {
              "yum": {
                "httpd": []
              }
            },
            "files": {
              "/var/www/html/index.html": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "<h1>Congratulations, you have successfully launched the Apache webserver demo.</h1>"
                    ]
                  ]
                },
                "mode": "000644",
                "owner": "root",
                "group": "root"
              }
            },
            "services": {
              "sysvinit": {
                "httpd": {
                  "enabled": "true",
                  "ensureRunning": "true"
                }
              }
            }
          }
        }
      },
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "ImageId": {
          "Ref":"LatestAmiId"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags" : [
          {"Key" : "Name", "Value" : {"Fn::Sub":"EC2-Apache-${AWS::StackName}"} }
        ],
        "NetworkInterfaces": [
          {
            "GroupSet": [
              {
                "Ref": "WebServerSecurityGroup"
              }
            ],
            "AssociatePublicIpAddress": "true",
            "DeviceIndex": "0",
            "DeleteOnTermination": "true",
            "SubnetId": {
              "Ref": "PublicSubnet"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum update -y aws-cfn-bootstrap\n",
                "# Install the files and packages from the metadata\n",
                "/opt/aws/bin/cfn-init -v ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource WebServerInstance ",
                "         --configsets All ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "# Signal the status from cfn-init\n",
                "/opt/aws/bin/cfn-signal -e $? ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource WebServerInstance ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n"
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT5M"
        }
      }
    }
    },
    "Outputs": {
    "WebsiteURL": {
      "Description": "DNS root URL of the new webserver",
      "Value" : { "Fn::Join" : [ "", ["http://", { "Fn::GetAtt" : ["WebServerInstance", "PublicDnsName"] }]]}
    },
    "WebsiteIP": {
      "Description": "IP root URL of the new webserver",
      "Value" : { "Fn::Join" : [ "", ["http://", { "Fn::GetAtt" : ["WebServerInstance", "PublicIp"] }]]}
    }
  }
}